<!DOCTYPE html>
<html>
<head>

<script id="vertex-shader" type="x-shader/x-vertex">

    precision mediump float;

    attribute vec4 vertexPosition;
    attribute vec3 nv;

    uniform mat4 M;
    uniform mat4 P;
    uniform vec3 Lp0, Lp1;
    uniform vec3 Ia0, Id0, Is0;
    uniform vec3 Ia1, Id1, Is1;

    varying vec3 Ia0_pp0, Id0_pp0, Is0_pp0;
    varying vec3 Ia1_pp0, Id1_pp0, Is1_pp0;
    varying vec3 i0, i1;
    varying vec3 v;
    varying vec3 n;

    mat4 proj = mat4(1.0, 0, 0, 0,
                     0, 1.0, 0, 0,
                     0, 0, -1.0, 0,
                     0, 0, 0, 1);
    void main() {
        gl_PointSize = 1.0;
        float L0distance = length(vertexPosition.xyz - Lp0);
        float L1distance = length(vertexPosition.xyz - Lp1);
        Ia0_pp0 = Ia0 / (L0distance*L0distance);
        Id0_pp0 = Id0 / (L0distance*L0distance);
        Is0_pp0 = Is0 / (L0distance*L0distance);
        Ia1_pp0 = Ia1 / (L1distance*L1distance);
        Id1_pp0 = Id1 / (L1distance*L1distance);
        Is1_pp0 = Is1 / (L1distance*L1distance);
        i0 = normalize(Lp0 - vertexPosition.xyz);
        i1 = normalize(Lp1 - vertexPosition.xyz);
        v = normalize(vec3(0.0, 0.0, 0.0) - vertexPosition.xyz);
        n = nv;
        gl_Position = proj * P * M * vertexPosition;
    }

</script>

<script id="fragment-shader" type="x-shader/x-fragment">

    precision mediump float;

    uniform vec3 ka0, kd0, ks0;
    uniform vec3 ka1, kd1, ks1;
    uniform float alpha;

    varying vec3 Ia0_pp0, Id0_pp0, Is0_pp0;
    varying vec3 Ia1_pp0, Id1_pp0, Is1_pp0;
    varying vec3 i0, i1;
    varying vec3 v;
    varying vec3 n;
    void main() {
        vec3 i0n, i1n, nn, vn;
        i0n = normalize(i0);
        i1n = normalize(i1);
        nn = normalize(n);
        vn = normalize(v);

        vec3 Ra0, Rd0, Rs0, Ra1, Rd1, Rs1;

        Ra0.r = ka0.r*Ia0_pp0.r;
        Ra1.r = ka1.r*Ia1_pp0.r;
        Rd0.g = kd0.g*Id0_pp0.g;
        Rd1.g = kd1.g*Id1_pp0.g;
        Rs0.b = ks0.b*Is0_pp0.b;
        Rs1.b = ks1.b*Is1_pp0.b;

        float costheta0 = dot(i0n, nn);
        float costheta1 = dot(i1n, nn);
        Ra0.r = ka0.r*Ia0_pp0.r*max(costheta0, 0.0);
        Ra1.r = ka1.r*Ia1_pp0.r*max(costheta1, 0.0);
        Rd0.g = kd0.g*Id0_pp0.g*max(costheta0, 0.0);
        Rd1.g = kd1.g*Id1_pp0.g*max(costheta1, 0.0);
        Rs0.b = ks0.b*Is0_pp0.b*max(costheta0, 0.0);
        Rs1.b = ks1.b*Is1_pp0.b*max(costheta1, 0.0);

        vec3 r0 = normalize(2.0*costheta0*nn - i0n);
        vec3 r1 = normalize(2.0*costheta1*nn - i1n);
        float cosphi0 = dot(r0, vn);
        float cosphi1 = dot(r1, vn);
        float shiny0 = pow(max(cosphi0, 0.0), alpha);
        float shiny1 = pow(max(cosphi1, 0.0), alpha);
        float costhetag0 = floor(0.5*(sign(costheta0)+1.0));
        float costhetag1 = floor(0.5*(sign(costheta1)+1.0));
        Ra0.r = ka0.r*Ia0_pp0.r*shiny0*costhetag0;
        Ra1.r = ka1.r*Ia1_pp0.r*shiny1*costhetag1;
        Rd0.g = kd0.g*Id0_pp0.g*shiny0*costhetag0;
        Rd1.g = kd1.g*Id1_pp0.g*shiny1*costhetag1;
        Rs0.b = ks0.b*Is0_pp0.b*shiny0*costhetag0;
        Rs1.b = ks1.b*Is1_pp0.b*shiny1*costhetag1;

        vec3 R = clamp(Ra0 + Rd0 + Rs0 + Ra1 + Rd1 + Rs1, 0.0, 1.0);

        gl_FragColor = vec4( R.r, R.g, R.b, 1.0 );
    }

</script>

<script type="text/javascript" src="../Common/webgl-utils.js"></script>
<script type="text/javascript" src="../Common/initShaders.js"></script>
<script type="text/javascript" src="../Common/MV.js"></script>
<script type="text/javascript" src="lab4.js"></script>
<script type="text/javascript" src="object.js"></script>
</head>

<body onload = "initGL()"  onkeydown="update(event)">
    <canvas id="gl-canvas" height="512" width="512">
    </canvas>
</body>
</html>
